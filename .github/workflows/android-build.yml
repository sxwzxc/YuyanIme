name: Android Build

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 8.6

      - name: Prepare submodules
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:
          git submodule update --init --recursive

      - name: Prepare CI keystore
        run: |
          mkdir -p keystore
          KEYSTORE_PASSWORD="$(openssl rand -hex 16)"
          keytool -genkeypair -keystore keystore/ci.jks -alias ci -keyalg RSA -keysize 2048 -validity 10000 -storepass "$KEYSTORE_PASSWORD" -keypass "$KEYSTORE_PASSWORD" -dname "CN=CI, OU=CI, O=CI, L=CI, ST=CI, C=CN"
          cat > keystore/keystore.properties <<EOF
          storeFile=ci.jks
          storePassword=$KEYSTORE_PASSWORD
          keyAlias=ci
          keyPassword=$KEYSTORE_PASSWORD
          EOF

      - name: Build debug APK
        run: gradle assembleDebug
